import React, { useState, useCallback } from 'react';

/**
 * AIChat Component - Simulates an AI chat service for trading advice.
 *
 * NOTE: This component replaces the call to the broken 'monkedev.com' API
 * with a placeholder function that returns static, simulated advice.
 */
const AIChat = ({ currentPrice, aiRecommendations }) => {
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const [isThinking, setIsThinking] = useState(false);

    const simulatedAiResponse = useCallback((userQuery) => {
        // Simple logic to provide a relevant, static response based on price.
        let advice;
        if (currentPrice > 1000) {
            advice = "The simulated asset is currently experiencing strong upward momentum. While past performance is no guarantee, recent high volume suggests a 'hold' or a minor 'sell' to realize profits might be prudent, given the risk of a sharp correction.";
        } else if (currentPrice < 500) {
            advice = "The simulated asset is trading at a significantly low price point. This could represent a strong entry opportunity for long-term simulation. Consider initiating a 'buy' with a small portion of your balance.";
        } else {
            advice = "The market is consolidating around the average price. Short-term moves are uncertain. Our model suggests maintaining your current 'hold' position and watching for a clear breakout above $750 or below $450 before taking action.";
        }

        const analysis = aiRecommendations.length > 0
            ? `\n\nLatest AI Grounding Data: ${aiRecommendations[0]}`
            : "";

        return `${advice}${analysis}`;

    }, [currentPrice, aiRecommendations]);

    const handleSendMessage = useCallback(async (e) => {
        e.preventDefault();
        if (!input.trim() || isThinking) return;

        const userMessage = input.trim();
        const newMessage = { sender: 'user', text: userMessage };
        
        // Add user message immediately
        setMessages(prev => [...prev, newMessage]);
        setInput('');
        setIsThinking(true);

        // Simulate API call delay using a Promise/setTimeout
        await new Promise(resolve => setTimeout(resolve, 1500)); 

        // Get the simulated response
        const aiResponseText = simulatedAiResponse(userMessage);

        const aiMessage = { sender: 'ai', text: aiResponseText };
        setMessages(prev => [...prev, aiMessage]);
        setIsThinking(false);
    }, [input, isThinking, simulatedAiResponse]);

    return (
        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 h-96 flex flex-col">
            <h2 className="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">
                Simulated AI Trading Assistant
            </h2>
            
            {/* Message Display Area */}
            <div className="flex-1 overflow-y-auto space-y-4 mb-4 pr-2">
                {messages.length === 0 ? (
                    <p className="text-gray-500 italic text-center pt-8">
                        Ask the AI for advice! (e.g., "Should I buy now?")
                    </p>
                ) : (
                    messages.map((msg, index) => (
                        <div key={index} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                            <div className={`max-w-[80%] p-3 rounded-lg shadow-md ${
                                msg.sender === 'user' 
                                ? 'bg-indigo-500 text-white' 
                                : 'bg-gray-200 text-gray-800'
                            }`}>
                                {msg.text}
                            </div>
                        </div>
                    ))
                )}
                {isThinking && (
                     <div className="flex justify-start">
                        <div className="max-w-[80%] p-3 rounded-lg bg-gray-200 text-gray-500 italic">
                            AI is analyzing...
                        </div>
                    </div>
                )}
            </div>

            {/* Input Form */}
            <form onSubmit={handleSendMessage} className="flex space-x-2">
                <input
                    type="text"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    placeholder="Ask the AI for advice..."
                    className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                    disabled={isThinking}
                />
                <button
                    type="submit"
                    className="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50 shadow-md"
                    disabled={!input.trim() || isThinking}
                >
                    Send
                </button>
            </form>
        </div>
    );
};

export default AIChat;